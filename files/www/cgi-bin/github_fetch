#!/bin/sh

# CGI header
printf 'Content-Type: application/json\n\n'

# Read query string (from env or first arg)
QUERY_STRING="${QUERY_STRING:-$1}"

# Extract tag parameter (simple URL-decode of %XX sequences and +->space not needed here)
# Use parameter expansion and sed to get tag value if present, otherwise use whole string
TAG=$(printf '%s' "$QUERY_STRING" | sed -n 's/.*[?&]*tag=\([^&]*\).*/\1/p')
# Decode percent-encoding (handles %2B, %2F, etc.)
TAG=$(printf '%b' "$(printf '%s' "$TAG" | sed 's/+/ /g;s/%/\\x/g')")

# Extract repo parameter
REPO=$(printf '%s' "$QUERY_STRING" | sed -n 's/.*[?&]*repo=\([^&]*\).*/\1/p')
REPO=$(printf '%b' "$(printf '%s' "$REPO" | sed 's/+/ /g;s/%/\\x/g')")

# Validate repo format (owner/name, alphanumeric with hyphens/underscores/dots)
if ! printf '%s' "$REPO" | grep -qE '^[A-Za-z0-9._-]+/[A-Za-z0-9._-]+$'; then
  printf '{"error":"missing or invalid repo parameter"}'
  exit 1
fi

# basic validation
if [ -z "$TAG" ]; then
  printf '{"error":"missing tag"}'
  exit 1
fi

# Fetch release metadata once
RELEASE_JSON=$(curl -sS "https://api.github.com/repos/$REPO/releases/tags/$TAG") || {
  printf '{"error":"failed to fetch release metadata"}'
  exit 1
}

# Extract sysupgrade asset URL and sha256sums asset URL and any inline digest
URL=$(printf '%s' "$RELEASE_JSON" | jq -r '.assets[] | select(.browser_download_url|contains("sysupgrade")) | .browser_download_url // empty' | head -n1)
if [ -z "$URL" ]; then
  printf '{"error":"No sysupgrade firmware found"}'
  exit 1
fi

FILENAME=$(basename "$URL")
# Try: 1) sha256sums asset file, 2) asset .digest field (sha256:)
SHA256_URL=$(printf '%s' "$RELEASE_JSON" | jq -r '.assets[] | select(.browser_download_url|contains("sha256sums")) | .browser_download_url // empty' | head -n1)
# download sha256sums and extract matching line
[ -n "$SHA256_URL" ] && SHA256=$(curl -sSL "$SHA256_URL" | sed -n "s|\([0-9a-fA-F]*\).*${FILENAME}.*|\1|p")
# fallback to metadata if present
[ -z "$SHA256" ] && SHA256=$(printf '%s' "$RELEASE_JSON" | jq -r '.assets[] | select(.browser_download_url|contains("sysupgrade")) | .digest // empty' | sed -n 's/^sha256://p' | head -n1)

if [ -z "$SHA256" ]; then
  # If still missing, report and stop
  printf '{"error":"Could not get SHA256 hash for %s"}' "$FILENAME"
  exit 1
fi

# Download firmware and verify SHA256
FIRMWAREFILE="/tmp/firmware.bin"
if curl -sS -L -o "$FIRMWAREFILE" "$URL" && printf '%s  %s\n' "$SHA256" "$FIRMWAREFILE" | sha256sum -cs >/dev/null 2>&1; then
  printf '{"success":true,"path":"%s"}' "$FIRMWAREFILE"
  exit 0
else
  printf '{"error":"SHA256 hash mismatch for downloaded firmware"}'
  rm -f "$FIRMWAREFILE"
  exit 1
fi